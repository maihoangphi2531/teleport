local TeleportService = game:GetService("TeleportService")
local isTeleporting = false -- Biến khóa để đảm bảo các hoạt động khác dừng lại khi teleport

-- [[ DANH SÁCH ID ]]

local dungeonId = {
    [2978696440] = 'Crabby Crusade (1-1)', 
    [4310476380] = 'Scarecrow Defense (1-2)', 
    [4310464656] = 'Dire Problem (1-3)',
    [4310478830] = 'Kingslayer (1-4)',
    [3383444582] = 'Gravetower Dungeon (1-5)',
    [3885726701] = 'Temple of Ruin (2-1)',
    [3994953548] = 'Mama Trauma (2-2)',
    [4050468028] = "Volcano's Shadow (2-3)",
    [3165900886] = 'Volcano Dungeon (2-4)',
    [4465988196] = 'Mountain Pass (3-1)',
    [4465989351] = 'Winter Cavern (3-2)',
    [4465989998] = 'Winter Dungeon (3-3)',
    [4646473427] = 'Scrap Canyon (4-1)',
    [4646475342] = 'Deserted Burrowmine (4-2)',
    [4646475570] = 'Pyramid Dungeon (4-3)',
    [6386112652] = 'Konoh Heartlands (5-1)',
    [6510862058] = 'Atlantic Atoll (6-1)',
    [6847034886] = 'Mezuvia Skylands (7-1)',
    [10795158121] = 'Gold Farming',
    [13988110964] = 'inf'
}

local towerId = {
    [5703353651] = 'Prison Tower',
    [6075085184] = 'Atlantis Tower',
    [7071564842] = 'Mezuvian Tower'
}

local lobbyId = {
    [2727067538] = 'Main menu',
    [4310463616] = 'World 1',
    [4310463940] = 'World 2',
    [4465987684] = 'World 3',
    [4646472003] = 'World 4',
    [5703355191] = 'World 5',
    [6075083204] = 'World 6',
    [6847035264] = 'World 7',
    -- World 8 không có trong danh sách gốc, bạn có thể thêm ID vào đây nếu cần
    [10651517727] = 'world 9'
}

-- [[ CẬP NHẬT: DANH SÁCH WORLD MỤC TIÊU ĐỂ DỊCH CHUYỂN VÀ START RAID ]]
local targetWorlds = {
    4465987684, -- World 3
    4646472003, -- World 4
    5703355191, -- World 5
    6075083204, -- World 6
    6847035264, -- World 7
}

-- [[ CÁC HÀM TIỆN ÍCH ]]

-- Hàm để dừng tất cả các hoạt động script
local function stopAllScripts()
    while isTeleporting do
        warn("Script đang tạm dừng do teleport...")
        wait(1) -- Đợi một khoảng thời gian ngắn để ngăn các hoạt động khác tiếp tục
    end
end

local function isGameLoaded()
    stopAllScripts() -- Dừng trước khi kiểm tra game
    return game:IsLoaded()
end

-- Hàm tiện ích để kiểm tra xem PlaceId hiện tại có nằm trong danh sách world mục tiêu không
local function isInTargetWorld()
    for _, worldId in ipairs(targetWorlds) do
        if game.PlaceId == worldId then
            return true
        end
    end
    return false
end

-- Hàm để thực hiện Start Raid
local function startRaid()
    warn("Đang thực hiện Start Raid...")
    local args = { [1] = 34 } -- ID của raid, giữ nguyên là 34
    
    local replicatedStorage = game:GetService("ReplicatedStorage")
    local teleportModule = replicatedStorage:WaitForChild("Shared", 5):WaitForChild("Teleport", 5)
    
    if teleportModule then
        local startRaidEvent = teleportModule:WaitForChild("StartRaid", 5)
        if startRaidEvent then
            startRaidEvent:FireServer(unpack(args))
        else
            warn("Không tìm thấy StartRaidEvent.")
        end
    else
        warn("Không tìm thấy module Teleport.")
    end
end


-- [[ HÀM CHÍNH ĐỂ DỊCH CHUYỂN VÀ RAID ]]

local function teleportAndRaidLogic()
    stopAllScripts() -- Dừng trước khi bắt đầu
    if isTeleporting then
        warn("Script đang dừng do teleport đang diễn ra.")
        return -- Dừng lại nếu đã có teleport đang thực hiện
    end

    isTeleporting = true -- Đặt khóa để dừng các hoạt động khác

    local success, err = pcall(function()
        -- Trường hợp 1: Nếu đang ở Main Menu -> Dịch chuyển ngẫu nhiên đến một world trong danh sách
        if game.PlaceId == 2727067538 then
            local randomWorldId = targetWorlds[math.random(1, #targetWorlds)]
            warn("Teleporting from Main Menu to random world: " .. (lobbyId[randomWorldId] or randomWorldId))
            TeleportService:Teleport(randomWorldId)
        
        -- Trường hợp 2: Nếu đang ở một trong các world mục tiêu -> Bắt đầu raid
        elseif isInTargetWorld() then
            warn("Đã ở trong world mục tiêu. Bắt đầu Raid.")
            startRaid()
        end
    end)

    if not success then
        warn("Error during teleport/raid logic: " .. err)
    end

    -- Sau khi kết thúc (dù thành công hay thất bại), thả khóa sau vài giây để ổn định
    wait(10)
    isTeleporting = false
end

-- [[ CÁC HÀM KIỂM TRA VỊ TRÍ ]]

function lobbyCheck()
    stopAllScripts()
    for i, v in pairs(lobbyId) do
        if game.PlaceId == i then
            warn("Lobby:", v)
            return true
        end
    end
    return false
end

function dungeonCheck()
    stopAllScripts()
    for i, v in pairs(dungeonId) do
        if game.PlaceId == i then
            warn("Dungeon:", v)
            return true
        end
    end
    return false
end 

function towerCheck()
    stopAllScripts()
    for i, v in pairs(towerId) do
        if game.PlaceId == i then
            warn("Tower:", v)
            return true
        end
    end
    return false
end

-- [[ VÒNG LẶP CHÍNH VÀ COROUTINE ]]

local function checkAndExecuteLogic()
    stopAllScripts()
    warn('Checking location...')

    -- [[ THAY ĐỔI Ở ĐÂY ]] --
    -- Nếu người chơi đang ở World 2, không làm gì cả và thoát khỏi hàm
    if game.PlaceId == 4310463940 then
        warn("Đang ở World 2, tạm dừng script auto raid.")
        return
    end
    -- [[ KẾT THÚC THAY ĐỔI ]] --

    if isTeleporting then
        return -- Nếu đang trong quá trình teleport, không làm gì cả
    end

    if isGameLoaded() then
        if lobbyCheck() then
            teleportAndRaidLogic()
        end
    else
        game.Loaded:Wait()
        warn('Game Loaded')
        if lobbyCheck() then
            teleportAndRaidLogic()
        end
    end
end

local function mainCoroutine()
    while true do
        if not isTeleporting then
            checkAndExecuteLogic()
        end
        wait(10) -- Tần suất kiểm tra
    end
end

-- Khởi chạy coroutine chính
coroutine.wrap(mainCoroutine)()

-- Coroutine này có vẻ là một cơ chế dự phòng, giữ lại theo yêu cầu
local function runAfter7Minutes()
    stopAllScripts()
    
    -- Chờ 7 phút (420 giây)
    wait(420)

    warn("7 minutes passed. Firing StartRaid as a fallback.")
    startRaid()
end

-- Bắt đầu coroutine để không ảnh hưởng đến các hàm khác
task.spawn(runAfter7Minutes)
