local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local isTeleporting = false

-- L·∫•y Remote ƒë·ªÉ teleport
local Shared = ReplicatedStorage:WaitForChild("Shared", 10)
local TeleportRemote = Shared and Shared:WaitForChild("Teleport", 10)
local TeleportToHub = TeleportRemote and TeleportRemote:WaitForChild("TeleportToHub", 10)
local JoinGame = TeleportRemote and TeleportRemote:WaitForChild("JoinGame", 10) -- Remote d√πng cho Main Menu
local StartRaid = TeleportRemote and TeleportRemote:WaitForChild("StartRaid", 10)

-- [[ DANH S√ÅCH ID ]]

local dungeonId = {
    [2978696440] = 'Crabby Crusade (1-1)', 
    [4310476380] = 'Scarecrow Defense (1-2)', 
    [4310464656] = 'Dire Problem (1-3)',
    [4310478830] = 'Kingslayer (1-4)',
    [3383444582] = 'Gravetower Dungeon (1-5)',
    [3885726701] = 'Temple of Ruin (2-1)',
    [3994953548] = 'Mama Trauma (2-2)',
    [4050468028] = "Volcano's Shadow (2-3)",
    [3165900886] = 'Volcano Dungeon (2-4)',
    [4465988196] = 'Mountain Pass (3-1)',
    [4465989351] = 'Winter Cavern (3-2)',
    [4465989998] = 'Winter Dungeon (3-3)',
    [4646473427] = 'Scrap Canyon (4-1)',
    [4646475342] = 'Deserted Burrowmine (4-2)',
    [4646475570] = 'Pyramid Dungeon (4-3)',
    [6386112652] = 'Konoh Heartlands (5-1)',
    [6510862058] = 'Atlantic Atoll (6-1)',
    [6847034886] = 'Mezuvia Skylands (7-1)',
    [10795158121] = 'Gold Farming',
    [13988110964] = 'inf'
}

local towerId = {
    [5703353651] = 'Prison Tower',
    [6075085184] = 'Atlantis Tower',
    [7071564842] = 'Mezuvian Tower'
}

local lobbyId = {
    [2727067538] = 'Main menu',
    [4310463616] = 'World 1',
    [4310463940] = 'World 2',
    [4465987684] = 'World 3',
    [4646472003] = 'World 4',
    [5703355191] = 'World 5',
    [6075083204] = 'World 6',
    [6847035264] = 'World 7',
    [10651517727] = 'World 9'
}

-- [[ DANH S√ÅCH WORLD V·ªöI ID REMOTE (d√πng cho TeleportToHub) ]]
local worldRemoteIds = {
    World1 = { Name = 'World 1', Id = 13, PlaceId = 4310463616 },
    World2 = { Name = 'World 2', Id = 19, PlaceId = 4310463940 },
    World3 = { Name = 'World 3', Id = 20, PlaceId = 4465987684 },
    World4 = { Name = 'World 4', Id = 29, PlaceId = 4646472003 },
    World5 = { Name = 'World 5', Id = 31, PlaceId = 5703355191 },
    World6 = { Name = 'World 6', Id = 36, PlaceId = 6075083204 },
    World7 = { Name = 'World 7', Id = 40, PlaceId = 6847035264 },
    World8 = { Name = 'World 8', Id = 45, PlaceId = nil },
    World9 = { Name = 'World 9', Id = 49, PlaceId = 10651517727 },
    World10 = { Name = 'World 10', Id = 56, PlaceId = nil },
}

-- [[ DANH S√ÅCH WORLD M·ª§C TI√äU ]]
local targetWorldRemoteIds = {
    20, -- World 3
    29, -- World 4
    31, -- World 5
    36, -- World 6
}

-- [[ C√ÅC H√ÄM TI·ªÜN √çCH ]]

local function stopAllScripts()
    while isTeleporting do
        warn("Script ƒëang t·∫°m d·ª´ng do teleport...")
        wait(1)
    end
end

local function isGameLoaded()
    stopAllScripts()
    return game:IsLoaded()
end

local function isInTargetWorld()
    local targetPlaceIds = {4465987684, 4646472003, 5703355191, 6075083204}
    for _, placeId in ipairs(targetPlaceIds) do
        if game.PlaceId == placeId then
            return true
        end
    end
    return false
end

local function isAlive()
    local character = LocalPlayer.Character
    if not character then return false end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    return humanoid.Health > 0
end

local function checkVersion()
    if game.PlaceId == 2727067538 then
        return
    end
    
    local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
    
    local SettingsGui
    repeat
        SettingsGui = PlayerGui:FindFirstChild("Settings")
        if not SettingsGui then
            print("ƒêang t√¨m Settings GUI...")
            task.wait(0.5)
        end
    until SettingsGui
    
    local SettingsFrame
    repeat
        SettingsFrame = SettingsGui:FindFirstChild("Settings")
        if not SettingsFrame then
            print("ƒêang t√¨m Settings Frame...")
            task.wait(0.5)
        end
    until SettingsFrame
    
    local VersionLabel
    repeat
        VersionLabel = SettingsFrame:FindFirstChild("Version")
        if not VersionLabel then
            print("ƒêang t√¨m Version Label...")
            task.wait(0.5)
        end
    until VersionLabel
    
    local currentVersion
    repeat
        currentVersion = VersionLabel.Text
        if currentVersion == "" or currentVersion == "Version 0.0.0" or not currentVersion:find("Version") then
            print("ƒêang ƒë·ª£i version load... Hi·ªán t·∫°i: '" .. tostring(currentVersion) .. "'")
            task.wait(0.5)
        end
    until currentVersion ~= "" and currentVersion ~= "Version 0.0.0" and currentVersion:find("Version")
    
    local requiredVersion = "Version 2.8.3"
    
    if currentVersion ~= requiredVersion then
        LocalPlayer:Kick("Version kh√¥ng h·ª£p l·ªá! Y√™u c·∫ßu: " .. requiredVersion .. " | Version hi·ªán t·∫°i: " .. currentVersion)
    else
        print("Version h·ª£p l·ªá: " .. currentVersion)
    end
end






-- H√†m l·∫•y GUID c·ªßa profile hi·ªán t·∫°i
local function getProfileGUID()
    -- ·ªû Main Menu: l·∫•y t·ª´ ProfileCollection, ch·ªçn profile c√≥ nhi·ªÅu DiscoveredDungeons nh·∫•t
    if game.PlaceId == 2727067538 then
        local success, guid = pcall(function()
            local profilesParent = LocalPlayer:WaitForChild("PlayerGui", 10)
                :WaitForChild("ProfileCollection", 10)
                :WaitForChild("Profiles", 10)
            
            warn("‚è≥ ƒêang ƒë·ª£i Profiles load ho√†n to√†n...")
            
            -- C√°ch ch·∫Øc ch·∫Øn nh·∫•t: ƒê·ª£i cho ƒë·∫øn khi kh√¥ng c√≤n th√™m descendant m·ªõi trong 2 gi√¢y
            local lastDescendantTime = tick()
            local connection
            
            connection = profilesParent.DescendantAdded:Connect(function()
                lastDescendantTime = tick()
            end)
            
            -- ƒê·ª£i t·ªëi thi·ªÉu 3 gi√¢y, v√† ƒë·ª£i th√™m cho ƒë·∫øn khi kh√¥ng c√≥ descendant m·ªõi trong 2 gi√¢y
            task.wait(3)
            while (tick() - lastDescendantTime) < 2 do
                task.wait(0.5)
                warn("‚è≥ V·∫´n ƒëang load... (last activity: " .. string.format("%.1f", tick() - lastDescendantTime) .. "s ago)")
            end
            
            connection:Disconnect()
            warn("‚úÖ Profiles ƒë√£ load xong!")
            
            -- B√¢y gi·ªù m·ªõi ƒë·∫øm v√† ch·ªçn profile t·ªët nh·∫•t
            local bestGUID = nil
            local maxDungeons = -1
            local bestProfileName = ""
            
            for _, profile in ipairs(profilesParent:GetChildren()) do
                local guidObj = profile:FindFirstChild("GUID")
                if guidObj and guidObj:IsA("StringValue") and guidObj.Value ~= "" then
                    local discoveredDungeons = profile:FindFirstChild("DiscoveredDungeons")
                    local dungeonCount = 0
                    
                    if discoveredDungeons then
                        dungeonCount = #discoveredDungeons:GetChildren()
                    end
                    
                    warn("üìã Profile: " .. profile.Name .. " | GUID: " .. string.sub(guidObj.Value, 1, 8) .. "... | Dungeons: " .. dungeonCount)
                    
                    if dungeonCount > maxDungeons then
                        maxDungeons = dungeonCount
                        bestGUID = guidObj.Value
                        bestProfileName = profile.Name
                    end
                end
            end
            
            if bestGUID then
                warn("‚úÖ ƒê√£ ch·ªçn: " .. bestProfileName .. " (Dungeons: " .. maxDungeons .. ")")
            else
                warn("‚ùå Kh√¥ng t√¨m th·∫•y profile ph√π h·ª£p!")
            end
            
            return bestGUID
        end)
        return success and guid or nil
    else
        -- ·ªû trong Game: l·∫•y t·ª´ Profile
        local success, guid = pcall(function()
            return LocalPlayer:WaitForChild("PlayerGui", 10)
                :WaitForChild("Profile", 10)
                :WaitForChild("GUID", 10).Value
        end)
        return success and guid or nil
    end
end





-- H√†m ƒë·ªÉ th·ª±c hi·ªán Start Raid
local function startRaid()
    warn("ƒêang th·ª±c hi·ªán Start Raid...")
    local args = { [1] = 34 }
    
    if StartRaid then
        StartRaid:FireServer(unpack(args))
        warn("ƒê√£ g·ª≠i StartRaid request!")
    else
        warn("Kh√¥ng t√¨m th·∫•y StartRaid Remote.")
    end
end

-- H√†m teleport t·ª´ Main Menu (s·ª≠ d·ª•ng JoinGame)
local function teleportFromMainMenu(worldId)
    -- ·ªû Main Menu, c·∫ßn s·ª≠ d·ª•ng JoinGame Remote thay v√¨ TeleportToHub
    -- JoinGame y√™u c·∫ßu GUID c·ªßa profile
    
    local guid = getProfileGUID()
    if not guid then
        warn("Kh√¥ng th·ªÉ l·∫•y GUID c·ªßa profile!")
        return false
    end
    
    if JoinGame then
        -- JoinGame(guid, playTutorial)
        -- arg2 = GUID, arg3 = playTutorial (false = skip tutorial)
        JoinGame:FireServer(guid, false)
        warn("ƒê√£ g·ª≠i JoinGame request v·ªõi GUID: " .. tostring(guid))
        return true
    else
        warn("Kh√¥ng t√¨m th·∫•y JoinGame Remote!")
        return false
    end
end

-- H√†m teleport ƒë·∫øn world s·ª≠ d·ª•ng Remote (khi ƒë√£ ·ªü trong game)
local function teleportToWorld(remoteId)
    if not TeleportToHub then
        warn("Kh√¥ng t√¨m th·∫•y TeleportToHub Remote!")
        return false
    end
    
    -- Ch·ªâ ki·ªÉm tra isAlive() n·∫øu KH√îNG ph·∫£i ·ªü Main Menu
    if game.PlaceId ~= 2727067538 and not isAlive() then
        warn("Nh√¢n v·∫≠t ƒë√£ ch·∫øt, kh√¥ng th·ªÉ teleport!")
        return false
    end
    
    -- S·ª≠ d·ª•ng Remote c·ªßa game ƒë·ªÉ teleport
    TeleportToHub:FireServer(remoteId)
    warn("ƒê√£ g·ª≠i TeleportToHub request v·ªõi Remote Id: " .. tostring(remoteId))
    return true
end

-- [[ H√ÄM CH√çNH ƒê·ªÇ D·ªäCH CHUY·ªÇN V√Ä RAID ]]

local function teleportAndRaidLogic()
    if isTeleporting then
        warn("Script ƒëang d·ª´ng do teleport ƒëang di·ªÖn ra.")
        return
    end

    isTeleporting = true

    local success, err = pcall(function()
        -- Tr∆∞·ªùng h·ª£p 1: N·∫øu ƒëang ·ªü Main Menu -> S·ª≠ d·ª•ng JoinGame ƒë·ªÉ v√†o game
        if game.PlaceId == 2727067538 then
            warn("ƒêang ·ªü Main Menu, s·ª≠ d·ª•ng JoinGame ƒë·ªÉ v√†o game...")
            teleportFromMainMenu()
        
        -- Tr∆∞·ªùng h·ª£p 2: N·∫øu ƒëang ·ªü m·ªôt trong c√°c world m·ª•c ti√™u -> B·∫Øt ƒë·∫ßu raid
        elseif isInTargetWorld() then
            warn("ƒê√£ ·ªü trong world m·ª•c ti√™u. B·∫Øt ƒë·∫ßu Raid.")
            startRaid()
        
        -- Tr∆∞·ªùng h·ª£p 3: N·∫øu ƒëang ·ªü world kh√°c -> Teleport ƒë·∫øn world m·ª•c ti√™u
        else
            local randomRemoteId = targetWorldRemoteIds[math.random(1, #targetWorldRemoteIds)]
            
            local worldName = "Unknown"
            for key, data in pairs(worldRemoteIds) do
                if data.Id == randomRemoteId then
                    worldName = data.Name
                    break
                end
            end
            
            warn("Teleporting to " .. worldName .. " (Remote Id: " .. randomRemoteId .. ")")
            teleportToWorld(randomRemoteId)
        end
    end)

    if not success then
        warn("Error during teleport/raid logic: " .. err)
    end

    wait(2)
    isTeleporting = false
end

-- [[ C√ÅC H√ÄM KI·ªÇM TRA V·ªä TR√ç ]]

function lobbyCheck()
    stopAllScripts()
    for i, v in pairs(lobbyId) do
        if game.PlaceId == i then
            warn("Lobby:", v)
            return true
        end
    end
    return false
end

function dungeonCheck()
    stopAllScripts()
    for i, v in pairs(dungeonId) do
        if game.PlaceId == i then
            warn("Dungeon:", v)
            return true
        end
    end
    return false
end 

function towerCheck()
    stopAllScripts()
    for i, v in pairs(towerId) do
        if game.PlaceId == i then
            warn("Tower:", v)
            return true
        end
    end
    return false
end

-- [[ V√íNG L·∫∂P CH√çNH ]]

local function checkAndExecuteLogic()
    stopAllScripts()
    warn('Checking location...')

    if game.PlaceId ~= 2727067538 then
        checkVersion()
    end

    if isTeleporting then
        return
    end

    if isGameLoaded() then
        if lobbyCheck() then
            teleportAndRaidLogic()
        end
    else
        game.Loaded:Wait()
        warn('Game Loaded')
        if lobbyCheck() then
            teleportAndRaidLogic()
        end
    end
end

local function mainCoroutine()
    while true do
        if not isTeleporting then
            checkAndExecuteLogic()
        end
        wait(10)
    end
end

coroutine.wrap(mainCoroutine)()

-- C∆° ch·∫ø d·ª± ph√≤ng sau 7 ph√∫t
local function runAfter7Minutes()
    stopAllScripts()
    wait(420)
    warn("7 minutes passed. Firing StartRaid as a fallback.")
    startRaid()
end

task.spawn(runAfter7Minutes)
